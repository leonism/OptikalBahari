{%- comment -%}
  UNIVERSAL CLOUDINARY COMPONENT - BLUR-UP ENHANCED
{%- endcomment -%}

{%- if include.src -%}
  {%- assign raw_src = include.src | strip -%}
  {%- assign first_char = raw_src | slice: 0 -%}
  {%- if first_char == "/" -%}
    {%- assign clean_src = raw_src | slice: 1, raw_src.size -%}
  {%- else -%}
    {%- assign clean_src = raw_src -%}
  {%- endif -%}

  {%- assign image_alt = include.alt | default: include.title | default: site.title | escape -%}
  {%- assign image_ratio = include.ratio | default: "ratio-16x9" -%}

  {%- comment -%} High Quality Params {%- endcomment -%}
  {%- capture ai_params -%}c_fill,g_auto:subject,q_auto:good,e_sharpen:100{%- endcapture -%}

  {%- comment -%}
    Low Quality Placeholder (LQP):
    30px width, high blur, and auto-format to keep it ~1kb
  {%- endcomment -%}
  {%- capture lqp_params -%}c_fill,g_auto:subject,w_30,e_blur:1000,q_auto:low{%- endcapture -%}
  {%- assign placeholder_url = clean_src | cloudinary_url: lqp_params -%}

  <div class="image-ratio-wrapper {{ image_ratio }} blur-up-container" style="background-image: url('{{ placeholder_url }}'); background-size: cover;">

    <picture>
      <source
        srcset="{{ clean_src | cloudinary_url: ai_params | append: ',w_480,h_270' }} 480w,
                {{ clean_src | cloudinary_url: ai_params | append: ',w_768,h_432' }} 768w"
        type="image/avif"
      />
      <img
        src="{{ clean_src | cloudinary_url: ai_params | append: ',w_768,h_432' }}"
        alt="{{ image_alt }}"
        class="blur-target"
        loading="lazy"
        decoding="async"
        width="768"
        height="432"
        onload="this.classList.add('loaded');"
      />
    </picture>
  </div>
{%- endif -%}

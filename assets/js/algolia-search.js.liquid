---
permalink: /assets/js/algolia-search.js
---
document.addEventListener('DOMContentLoaded', function() { const searchContainer = document.getElementById('algolia-search-container'); if (!searchContainer) return;

// Configuration const algoliaConfig = { appId: '{{ site.data.algolia_credentials.application_id }}', apiKey: '{{ site.data.algolia_credentials.search_only_api_key }}', indexName: '{{ site.data.algolia_credentials.index_name }}', cloudinaryCloudName: '{{ site.data.cloudinary.cloud_name }}' };

if (!algoliaConfig.appId || algoliaConfig.appId === 'YOUR_ALGOLIA_APP_ID') { console.warn('Algolia Search: Credentials missing.'); return; }

// --- 1. Performance: Caching & Client Setup ---
const algoliaClient = algoliasearch(algoliaConfig.appId, algoliaConfig.apiKey);
// Custom Debounce Function
const debounce = (func, delay) => {
  let timeout;
  return (...args) => {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), delay);
  };
};

// --- 2. InstantSearch Initialization --- const search = instantsearch({ indexName: algoliaConfig.indexName, searchClient: algoliaClient, searchFunction: function(helper) { const resultsWrapper = document.getElementById('hits'); const query = helper.state.query;

if (query && query.trim() !== '') { // Debounced Search (100ms) if (!helper.debouncedSearch) { helper.debouncedSearch = debounce(() => { resultsWrapper.classList.add('has-results'); resultsWrapper.style.display = ''; // Clear inline style to let CSS take over helper.search(); }, 100); } helper.debouncedSearch(); } else {
resultsWrapper.classList.remove('has-results'); } } });

// --- 3. Widgets ---

// Search Box search.addWidgets([ instantsearch.widgets.searchBox({ container: '#searchbox', placeholder: 'Cari Optikal Bahari...', showReset: true, showSubmit: true, showLoadingIndicator: true, cssClasses: { root: 'custom-search-box', form: 'form-inline', input: 'form-control form-control-sm rounded-pill border custom-search', submit: 'btn
btn-link search-btn', reset: 'btn btn-link reset-btn' } }) ]);

// Sorting search.addWidgets([ instantsearch.widgets.sortBy({ container: '#sort-by', items: [ { label: 'Best Match', value: algoliaConfig.indexName }, { label: 'Newest', value: `${algoliaConfig.indexName}_date_desc` }, { label: 'Oldest', value: `${algoliaConfig.indexName}_date_asc` }, { label: 'Title (A-Z)', value:
`${algoliaConfig.indexName}_title_asc` }, { label: 'Title (Z-A)', value: `${algoliaConfig.indexName}_title_desc` } ], cssClasses: { select: 'form-control-sm border-0' } }) ]);

// Stats search.addWidgets([ instantsearch.widgets.stats({ container: '#search-stats', templates: { text: `
{% raw %}{{nbHits}} results ({{processingTimeMS}}ms){% endraw %}
` } }) ]);

// Hits
search.addWidgets([
  instantsearch.widgets.hits({ container: '#hits', cssClasses: { list: 'list-unstyled m-0', item: 'border-0 p-0' }, templates: { empty: '
{% raw %}<div class="p-3 text-center text-muted">No results found for "<strong>{{query}}</strong>"</div>{% endraw %}
', item: function(hit) { const background = hit.background || ''; const title = instantsearch.highlight({ attribute: 'title', hit }); const content = instantsearch.snippet({ attribute: 'content', hit }); const url = hit.url; let imageHtml = '';
          if (background) {
            imageHtml = `
              <div class="image-ratio-wrapper ratio-16x9">
                <img
                  src="${background}"
                  alt="${title}"
                  class="card-img-top"
                  style="position: absolute; top: 0; left: 0; object-fit: cover; object-position: center; width: 100%; height: 100%;"
                  loading="lazy"
                  onload="this.classList.add('loaded')"
                  onerror="this.style.display='none'"
                >
              </div>
            `;
          } else { imageHtml = `
<div class='w-100 h-100 bg-light d-flex align-items-center justify-content-center text-muted' style='min-height: 90px;'>
  <i class='fas fa-image'></i>
</div>
`; }

return `
<a href='${url}' class='result-item' role='option'>
  <div class='result-thumbnail'>
    <div class='img-container'>${imageHtml}</div>
  </div>
  <div class='result-content'>
    <h4>${title}</h4>
    <p>${content}</p>
  </div>
</a>
`; } } }) ]);

// Pagination search.addWidgets([ instantsearch.widgets.pagination({ container: '#pagination', scrollTo: false, showFirst: false, showLast: false, padding: 1, totalPages: 5 }), instantsearch.widgets.configure({ hitsPerPage: 20 }) ]);

// --- 4. Keyboard Navigation & Interaction ---
    let activeIndex = -1;
    const getSearchInput = () => {
      const container = document.getElementById('searchbox');
      return container ? (container.querySelector('.ais-SearchBox-input') || container.querySelector('.custom-search') || container.querySelector('input')) : null;
    };

    const updateSelection = (items) => {
      items.forEach((item, index) => {
        if (index === activeIndex) {
          item.classList.add('selected');
          item.setAttribute('aria-selected', 'true');
          item.scrollIntoView({ block: 'nearest' });
        } else {
          item.classList.remove('selected');
          item.setAttribute('aria-selected', 'false');
        }
      });
    };

    const handleKeyNavigation = (e) => {
      const resultsWrapper = document.getElementById('hits');
      // Use class check instead of display style
      if (!resultsWrapper.classList.contains('has-results')) return;

      const items = document.querySelectorAll('.result-item');
      if (items.length === 0) return;

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        activeIndex = (activeIndex + 1) % items.length;
        updateSelection(items);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        activeIndex = (activeIndex - 1 + items.length) % items.length;
        updateSelection(items);
      } else if (e.key === 'Enter') {
        if (activeIndex >= 0 && items[activeIndex]) {
          e.preventDefault();
          items[activeIndex].click();
        }
      } else if (e.key === 'Escape') {
        e.preventDefault();
        resultsWrapper.classList.remove('has-results');
        const input = getSearchInput();
        if (input) input.focus();
      }
    };

    // --- 5. Click/Tap Outside Detection ---
    const handleClickOutside = (e) => {
      const resultsWrapper = document.getElementById('hits');
      const searchBox = document.getElementById('searchbox');
      // Check if click is outside both wrapper and search input
      if (
        resultsWrapper &&
        searchBox &&
        !resultsWrapper.contains(e.target) &&
        !searchBox.contains(e.target) &&
        resultsWrapper.classList.contains('has-results')
      ) {
        resultsWrapper.classList.remove('has-results');
      }
    };

    // Re-open on focus if query exists
    const handleInputFocus = (e) => {
      if (e.target.matches('.ais-SearchBox-input') || e.target.matches('.custom-search')) {
        const resultsWrapper = document.getElementById('hits');
        if (e.target.value.trim() !== '') {
          resultsWrapper.classList.add('has-results');
          resultsWrapper.style.display = '';
        }
      }
    };

// Attach Listeners document.addEventListener('keydown', handleKeyNavigation); document.addEventListener('click', handleClickOutside); document.addEventListener('focusin', handleInputFocus);

// Reset navigation on new results
search.on('render', () => {
  activeIndex = -1;
  const list = document.querySelector('.ais-Hits-list');
  if (list) list.setAttribute('role', 'listbox');
});

// Error Handling
search.on('error', ({ error }) => {
  const resultsWrapper = document.getElementById('hits');
  if (resultsWrapper) {
    resultsWrapper.innerHTML = `<div class="p-3 text-center text-danger">Error: ${error.message}</div>`;
    resultsWrapper.classList.add('has-results');
    resultsWrapper.style.display = '';
  }
  console.error('Algolia Search Error:', error);
});

// Start Search
search.start();
});
